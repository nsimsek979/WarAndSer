{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{% block title %}Installation Scanner{% endblock title %}</title>
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'konnektom-logo.png' %}">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?v=3.4.0"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- QR Code Scanner - Daha stabil versiyon -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            corePlugins: {
                preflight: true,
            },
            theme: {
                extend: {
                    colors: {
                        primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a"},
                        gray: {
                            25: "#fcfcfd",
                            50: "#f9fafb",
                            100: "#f3f4f6", 
                            200: "#e5e7eb",
                            300: "#d1d5db",
                            400: "#9ca3af",
                            500: "#6b7280",
                            600: "#4b5563",
                            700: "#374151",
                            800: "#1f2937",
                            900: "#111827"
                        }
                    }
                }
            }
        }
    </script>

    <!-- Mobile optimizations -->
    <style>
        /* Font rendering optimization */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Mobile input optimizations */
        button, input, select, textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Touch optimizations */
        button, input, select {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Prevent zoom on input focus */
        input[type="text"], input[type="number"], textarea {
            font-size: 16px;
        }
        
        /* Focus styles */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* Consistent box-sizing */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        /* Reset margins */
        body, h1, h2, h3, h4, h5, h6, p, ul, ol, li, figure, figcaption, blockquote, dl, dd {
            margin: 0;
        }

        /* QR Scanner specific styles */
        #qr-reader {
            border-radius: 8px;
            overflow: hidden;
            width: 100% !important;
            height: 320px !important;
        }

        /* QR reader video element */
        #qr-reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            border-radius: 8px;
        }

        /* QR reader canvas element */
        #qr-reader canvas {
            width: 100% !important;
            height: 100% !important;
            border-radius: 8px;
        }

        /* Hide default QR scanner UI elements */
        #qr-reader__dashboard_section,
        #qr-reader__camera_selection,
        #qr-reader__camera_permission_button {
            display: none !important;
        }

        /* Custom scanner overlay */
        .scanner-overlay {
            position: relative;
            overflow: visible;
        }

        .scanner-overlay::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            margin: -100px 0 0 -100px;
            border: 3px solid #3b82f6;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
    </style>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'custom.css' %}?v=1.0">
</head>
<body class="h-full bg-gray-50" x-data="installationScanner()">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- Main Container -->
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img src="{% static 'konnektom-logo.png' %}" alt="Logo" class="h-8 w-8">
                        <h1 class="text-lg font-semibold text-gray-900">Installation Scanner</h1>
                    </div>
                    <button 
                        @click="showHelp = !showHelp"
                        class="text-gray-500 hover:text-gray-700 p-2"
                    >
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div x-show="showHelp" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
             @click.self="showHelp = false">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Nasıl Kullanılır?</h3>
                    <button @click="showHelp = false" class="text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-3 text-sm text-gray-600">
                    <p>• <strong>Barkod Tarama:</strong> Kameranızı ürünün QR koduna tutun</p>
                    <p>• <strong>Manuel Giriş:</strong> Barkod numarasını el ile yazın</p>
                    <p>• <strong>Seri No:</strong> Ürünün seri numarasını girin</p>
                    <p>• Bulunan ürün kurulum için hazır hale gelecektir</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="px-4 py-6">
            <!-- Scanner Tabs -->
            <div class="mb-6">
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                    <button 
                        @click="activeTab = 'scanner'"
                        :class="activeTab === 'scanner' ? 'bg-white text-primary-600 shadow-sm' : 'text-gray-500'"
                        class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all duration-200"
                    >
                        <i class="fas fa-qrcode mr-2"></i>
                        Barkod Tara
                    </button>
                    <button 
                        @click="activeTab = 'manual'"
                        :class="activeTab === 'manual' ? 'bg-white text-primary-600 shadow-sm' : 'text-gray-500'"
                        class="flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all duration-200"
                    >
                        <i class="fas fa-keyboard mr-2"></i>
                        Manuel Giriş
                    </button>
                </div>
            </div>

            <!-- Scanner Tab -->
            <div x-show="activeTab === 'scanner'" class="space-y-6">
                <!-- Camera Scanner -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b bg-gray-50">
                        <div class="flex items-center justify-between">
                            <h3 class="font-medium text-gray-900">Kamera ile Tara</h3>
                            <button 
                                @click="toggleScanner()"
                                :class="scannerActive ? 'bg-red-600 hover:bg-red-700' : 'bg-primary-600 hover:bg-primary-700'"
                                class="px-4 py-2 text-white text-sm font-medium rounded-md transition-colors"
                            >
                                <i :class="scannerActive ? 'fas fa-stop' : 'fas fa-play'" class="mr-2"></i>
                                <span x-text="scannerActive ? 'Durdur' : 'Başlat'"></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scanner Container -->
                    <div class="scanner-overlay">
                        <div id="qr-reader" x-show="scannerActive" class="w-full" style="height: 320px; min-height: 320px;"></div>
                        <div x-show="!scannerActive" class="w-full bg-gray-100 flex items-center justify-center" style="height: 320px;">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-camera text-4xl mb-3"></i>
                                <p class="mb-2">Taramayı başlatmak için "Başlat" butonuna tıklayın</p>
                                <p class="text-xs text-gray-400">QR kod veya barkod taramak için kamera iznine ihtiyaç vardır</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scanner Status -->
                    <div x-show="scannerActive" class="p-3 bg-green-50 border border-green-200 rounded-lg mt-3">
                        <div class="flex items-center justify-between text-sm text-green-800">
                            <div class="flex items-center">
                                <div class="animate-pulse w-2 h-2 bg-green-600 rounded-full mr-2"></div>
                                <span>Kamera aktif - QR kod veya barkodu kamera önüne tutun</span>
                            </div>
                            <button @click="debugCamera()" class="text-xs bg-green-100 hover:bg-green-200 px-2 py-1 rounded">
                                Debug
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Scan Result -->
                <div x-show="scannedCode" class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-green-800">Barkod Tarandı</p>
                            <p class="text-sm text-green-600" x-text="scannedCode"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Input Tab -->
            <div x-show="activeTab === 'manual'" class="space-y-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-4 border-b bg-gray-50">
                        <h3 class="font-medium text-gray-900">Manuel Giriş</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <!-- Barcode Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-qrcode mr-2"></i>
                                QR Kod
                            </label>
                            <input 
                                type="text" 
                                x-model="manualBarcode"
                                placeholder="QR kod veya seri numarasını girin..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            >
                        </div>

                        <!-- Serial Number Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-hashtag mr-2"></i>
                                Seri Numarası
                            </label>
                            <input 
                                type="text" 
                                x-model="serialNumber"
                                placeholder="Seri numarasını girin..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            >
                        </div>

                        <!-- Search Button -->
                        <button 
                            @click="searchItem()"
                            :disabled="!manualBarcode && !serialNumber"
                            :class="(!manualBarcode && !serialNumber) ? 'bg-gray-300 cursor-not-allowed' : 'bg-primary-600 hover:bg-primary-700'"
                            class="w-full py-3 px-4 text-white font-medium rounded-md transition-colors"
                        >
                            <i class="fas fa-search mr-2"></i>
                            Ürünü Bul
                        </button>
                    </div>
                </div>
            </div>

            <!-- Found Item Display -->
            <div x-show="foundItem" class="bg-white rounded-lg shadow-sm border border-gray-200 mt-6">
                <div class="p-4 border-b bg-gradient-to-r from-green-50 to-emerald-50">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            Bulunan Ürün
                        </h3>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ✓ Bulundu
                        </span>
                    </div>
                </div>
                <div class="p-6" x-show="foundItem">
                    <!-- Product Image -->
                    <div class="text-center mb-6">
                        <template x-if="foundItem?.image">
                            <img :src="foundItem.image" :alt="foundItem.name" 
                                 class="mx-auto h-24 w-24 object-cover rounded-lg border-2 border-gray-200 shadow-sm">
                        </template>
                        <template x-if="!foundItem?.image">
                            <div class="mx-auto h-24 w-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg border-2 border-gray-200 flex items-center justify-center shadow-sm">
                                <i class="fas fa-cube text-gray-400 text-2xl"></i>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Product Details -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Ürün Adı</div>
                            <div class="text-lg font-semibold text-gray-900" x-text="foundItem?.name || 'Bilinmiyor'"></div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Model</div>
                                <div class="font-medium text-gray-900" x-text="foundItem?.model || 'Belirtilmemiş'"></div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Seri Numarası</div>
                                <div class="font-medium text-gray-900 font-mono" x-text="foundItem?.serial_number || 'Belirtilmemiş'"></div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">QR Kod</div>
                                <div class="font-medium text-gray-900 font-mono" x-text="foundItem?.qr_code || 'Belirtilmemiş'"></div>
                            </div>
                            
                            <template x-if="foundItem?.brand">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Marka</div>
                                    <div class="font-medium text-gray-900" x-text="foundItem.brand"></div>
                                </div>
                            </template>
                            
                            <template x-if="foundItem?.category">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Kategori</div>
                                    <div class="font-medium text-gray-900" x-text="foundItem.category"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Installation Status Warning -->
                    <div x-show="foundItem?.is_installed || foundItem?.in_used" 
                         class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-red-800">Kurulum Yapılamaz</p>
                                <p class="text-sm text-red-600">This item is already in use, it is not allowed to install</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-6 space-y-3">
                        <button 
                            x-show="!foundItem?.is_installed && !foundItem?.in_used"
                            @click="proceedToInstallation()"
                            class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-4 px-6 rounded-lg font-semibold text-lg transition-all transform hover:scale-105 shadow-lg"
                        >
                            <i class="fas fa-tools mr-2"></i>
                            Kuruluma Başla
                        </button>
                        <button 
                            x-show="foundItem?.is_installed || foundItem?.in_used"
                            disabled
                            class="w-full bg-gray-300 text-gray-500 py-4 px-6 rounded-lg font-semibold text-lg cursor-not-allowed"
                        >
                            <i class="fas fa-ban mr-2"></i>
                            Kurulum Yapılamaz
                        </button>
                        <button 
                            @click="resetSearch()"
                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium transition-colors border border-gray-300"
                        >
                            <i class="fas fa-redo mr-2"></i>
                            Yeni Arama
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div x-show="errorMessage" class="bg-red-50 border border-red-200 rounded-lg p-4 mt-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-red-800">Hata</p>
                        <p class="text-sm text-red-600" x-text="errorMessage"></p>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"></div>
                    <span class="text-gray-700">Aranıyor...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js Component -->
    <script>
        function installationScanner() {
            return {
                activeTab: 'scanner',
                scannerActive: false,
                scanner: null,
                scannedCode: '',
                manualBarcode: '',
                serialNumber: '',
                foundItem: null,
                loading: false,
                errorMessage: '',
                showHelp: false,

                toggleScanner() {
                    if (this.scannerActive) {
                        this.stopScanner();
                    } else {
                        // Html5Qrcode kütüphanesi yüklü mü kontrol et
                        if (typeof Html5Qrcode === 'undefined') {
                            this.errorMessage = 'QR kütüphanesi yüklenemedi. Sayfayı yenileyin veya internet bağlantınızı kontrol edin.';
                            console.error('Html5Qrcode kütüphanesi yüklenmemiş');
                            return;
                        }

                        // Kamera desteği kontrolü
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            this.errorMessage = 'Bu tarayıcı kamera desteği sağlamıyor. Lütfen modern bir tarayıcı kullanın (Chrome, Firefox, Safari).';
                            return;
                        }
                        
                        // HTTPS kontrolü (bazı tarayıcılar HTTPS gerektiriyor)
                        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                            this.errorMessage = 'Kamera erişimi için HTTPS gerekli. Lütfen güvenli bağlantı kullanın.';
                            return;
                        }
                        
                        this.startScanner();
                    }
                },

                startScanner() {
                    this.errorMessage = '';
                    console.log('Scanner başlatılıyor...');
                    
                    // Html5Qrcode tekrar kontrol et
                    if (typeof Html5Qrcode === 'undefined') {
                        this.errorMessage = 'QR scanner kütüphanesi henüz yüklenmedi. Lütfen birkaç saniye bekleyip tekrar deneyin.';
                        return;
                    }
                    
                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.777778, // 16:9 aspect ratio
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
                        experimentalFeatures: {
                            useBarCodeDetectorIfSupported: true
                        },
                        rememberLastUsedCamera: true,
                        showTorchButtonIfSupported: true
                    };

                    try {
                        this.scanner = new Html5Qrcode("qr-reader");
                    } catch (error) {
                        console.error('Html5Qrcode initialization error:', error);
                        this.errorMessage = 'QR scanner başlatılamadı. Sayfayı yenileyin.';
                        return;
                    }
                    
                    // Önce environment kamerasını dene, sonra user kamerasını
                    const cameraConfigs = [
                        { facingMode: "environment" },  // Arka kamera (mobil)
                        { facingMode: "user" },         // Ön kamera
                        "default"                       // Varsayılan kamera
                    ];
                    
                    this.tryCamera(cameraConfigs, 0, config);
                },

                tryCamera(cameraConfigs, index, config) {
                    if (index >= cameraConfigs.length) {
                        this.errorMessage = 'Hiçbir kamera bulunamadı. Lütfen kamera bağlantınızı kontrol edin.';
                        this.scannerActive = false;
                        return;
                    }

                    const cameraConfig = cameraConfigs[index];
                    console.log('Kamera denenliyor:', cameraConfig);
                    
                    this.scanner.start(
                        cameraConfig,
                        config,
                        (decodedText, decodedResult) => {
                            console.log('QR/Barkod okundu:', decodedText);
                            this.scannedCode = decodedText;
                            this.searchByCode(decodedText);
                            this.stopScanner();
                        },
                        (error) => {
                            // Tarama hatalarını sessizce işle
                        }
                    ).then(() => {
                        console.log('Kamera başarıyla başlatıldı');
                        this.scannerActive = true;
                        this.errorMessage = '';
                        
                        // Video element'ini kontrol et
                        setTimeout(() => {
                            const video = document.querySelector('#qr-reader video');
                            if (video) {
                                console.log('Video element bulundu:', video);
                                console.log('Video boyutları:', video.videoWidth, 'x', video.videoHeight);
                                console.log('Video görünür mü:', video.style.display !== 'none');
                            } else {
                                console.log('Video element bulunamadı');
                            }
                        }, 1000);
                        
                    }).catch((err) => {
                        console.log('Kamera hatası:', err);
                        // Bir sonraki kamerayı dene
                        this.tryCamera(cameraConfigs, index + 1, config);
                    });
                },

                stopScanner() {
                    if (this.scanner) {
                        this.scanner.stop().then(() => {
                            this.scannerActive = false;
                        }).catch((err) => {
                            this.scannerActive = false;
                        });
                    }
                },

                searchItem() {
                    if (this.manualBarcode) {
                        this.searchByCode(this.manualBarcode);
                    } else if (this.serialNumber) {
                        this.searchBySerial(this.serialNumber);
                    }
                },

                searchByCode(code) {
                    this.loading = true;
                    this.errorMessage = '';
                    
                    // API call to search by barcode
                    fetch(`/warranty-services/api/items/search-by-barcode/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({ barcode: code })
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.loading = false;
                        if (data.success) {
                            this.foundItem = data.item;
                        } else {
                            this.errorMessage = data.message || 'Ürün bulunamadı';
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        this.errorMessage = 'Arama sırasında bir hata oluştu';
                    });
                },

                searchBySerial(serial) {
                    this.loading = true;
                    this.errorMessage = '';
                    
                    // API call to search by serial number
                    fetch(`/warranty-services/api/items/search-by-serial/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({ serial_number: serial })
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.loading = false;
                        if (data.success) {
                            this.foundItem = data.item;
                        } else {
                            this.errorMessage = data.message || 'Ürün bulunamadı';
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        this.errorMessage = 'Arama sırasında bir hata oluştu';
                    });
                },

                proceedToInstallation() {
                    if (this.foundItem) {
                        // Check if item is already installed
                        if (this.foundItem.is_installed || this.foundItem.in_used) {
                            this.errorMessage = 'Bu ürün zaten kurulmuş veya kullanımda. Kurulum yapılamaz.';
                            return;
                        }
                        
                        // Redirect to installation form with item data
                        window.location.href = `/warranty-services/installation/mobile/form/?item_id=${this.foundItem.id}`;
                    }
                },

                resetSearch() {
                    this.foundItem = null;
                    this.scannedCode = '';
                    this.manualBarcode = '';
                    this.serialNumber = '';
                    this.errorMessage = '';
                    this.activeTab = 'scanner';
                },

                debugCamera() {
                    console.log('=== CAMERA DEBUG INFO ===');
                    console.log('Scanner Active:', this.scannerActive);
                    console.log('Scanner Object:', this.scanner);
                    
                    const qrReader = document.getElementById('qr-reader');
                    console.log('QR Reader Element:', qrReader);
                    
                    if (qrReader) {
                        console.log('QR Reader innerHTML:', qrReader.innerHTML);
                        console.log('QR Reader Children:', qrReader.children);
                        
                        const video = qrReader.querySelector('video');
                        if (video) {
                            console.log('Video Element Found:', video);
                            console.log('Video Display:', window.getComputedStyle(video).display);
                            console.log('Video Visibility:', window.getComputedStyle(video).visibility);
                            console.log('Video Width/Height:', video.videoWidth, 'x', video.videoHeight);
                            console.log('Video Style:', video.style.cssText);
                        } else {
                            console.log('Video Element NOT Found');
                        }
                        
                        const canvas = qrReader.querySelector('canvas');
                        if (canvas) {
                            console.log('Canvas Element Found:', canvas);
                        }
                    }
                    
                    // Alert olarak da göster
                    alert('Debug bilgileri console\'da. F12 ile Developer Tools açın ve Console sekmesine bakın.');
                },

                getCsrfToken() {
                    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                }
            }
        }
    </script>

    <!-- CSRF Token -->
    {% csrf_token %}
    
    <!-- QR Library Load Check -->
    <script>
        // Html5Qrcode kütüphanesinin yüklenmesini bekle
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof Html5Qrcode === 'undefined') {
                    console.error('Html5Qrcode kütüphanesi yüklenemedi');
                    // Alternatif CDN'den tekrar yüklemeyi dene
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js';
                    script.onload = function() {
                        console.log('Html5Qrcode alternative CDN\'den yüklendi');
                    };
                    script.onerror = function() {
                        console.error('Html5Qrcode alternative CDN\'den de yüklenemedi');
                    };
                    document.head.appendChild(script);
                } else {
                    console.log('Html5Qrcode başarıyla yüklendi');
                }
            }, 1000);
        });
    </script>
</body>
</html>
