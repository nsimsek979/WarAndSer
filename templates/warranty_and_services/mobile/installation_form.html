{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Installation Form - Mobile</title>
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'konnektom-logo.png' %}">

    <!-- Tailwind CSS -->
    <link href="{% static 'css/tailwind.css' %}" rel="stylesheet">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Mobile optimizations -->
    <style>
        /* Mobile font rendering optimization */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fix mobile input styles */
        button, input, select, textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Prevent zoom on input focus */
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"], textarea, select {
            font-size: 16px;
        }
        
        /* Mobile focus styles */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
    </style>

    <!-- Alpine.js Component Definition -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('installationForm', () => ({
                // Item data (passed from backend)
                item: {
                    id: {{ item.id }},
                    name: "{{ item.name.name|escapejs }}",
                    serial_no: "{{ item.serial_no|escapejs }}"
                },
                
                // Customer data
                customerSearch: '',
                customerResults: [],
                selectedCustomer: null,
                customerAddresses: [],
                selectedAddress: null,
                showNewCustomerForm: false,
                showCustomerResults: false,
                
                // New customer form
                newCustomer: {
                    name: '',
                    email: '',
                    telephone: '',
                    contact_person: '',
                    contact_phone: '',
                    contact_email: '',
                    daily_working_hours: 8,
                    working_on_saturday: false,
                    working_on_sunday: false
                },
                
                // Installation location data
                installation: {
                    setup_date: new Date().toISOString().split('T')[0],
                    setup_location: '',
                    location_address: '',
                    installation_notes: '',
                    technician_notes: '',
                    notes: '',
                    latitude: '',
                    longitude: ''
                },
                
                // Files and photos
                photos: [],
                files: [],
                
                // UI states
                loading: false,
                loadingMessage: '',
                submitting: false,
                gettingLocation: false,
                errorMessage: '',
                successMessage: '',
                showHelp: false,

                init() {
                    console.log('Installation form initialized with item:', this.item);
                },

                goBack() {
                    if (confirm('Formdan √ßƒ±kmak istediƒüinize emin misiniz? Girilen bilgiler kaybolacak.')) {
                        window.location.href = '/warranty-services/installation/mobile/';
                    }
                },

                async searchCustomers() {
                    console.log('üîç Customer search called with:', this.customerSearch);
                    
                    if (this.customerSearch.length < 2) {
                        this.customerResults = [];
                        this.showCustomerResults = false;
                        console.log('Search too short, clearing results');
                        return;
                    }

                    try {
                        console.log('Making API call to /warranty-services/api/customers/search/');
                        
                        const response = await fetch(`/warranty-services/api/customers/search/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({ 
                                search: this.customerSearch 
                            })
                        });

                        console.log('API Response status:', response.status);
                        const data = await response.json();
                        console.log('API Response data:', data);
                        
                        if (data.success) {
                            this.customerResults = data.customers;
                            this.showCustomerResults = data.customers.length > 0;
                            console.log('Found customers:', data.customers.length);
                        } else {
                            this.customerResults = [];
                            this.showCustomerResults = false;
                            console.log('API returned error:', data.message);
                        }
                    } catch (error) {
                        console.error('Customer search error:', error);
                        this.customerResults = [];
                        this.showCustomerResults = false;
                    }
                },

                selectCustomer(customer) {
                    this.selectedCustomer = customer;
                    this.customerSearch = customer.name;
                    this.customerResults = [];
                    this.showCustomerResults = false;
                    this.showNewCustomerForm = false;
                    
                    // Fetch customer addresses
                    this.fetchCustomerAddresses(customer.id);
                },

                clearCustomer() {
                    this.selectedCustomer = null;
                    this.customerSearch = '';
                    this.customerResults = [];
                    this.showCustomerResults = false;
                    this.customerAddresses = [];
                    this.selectedAddress = null;
                },

                async fetchCustomerAddresses(customerId) {
                    console.log('üè† Fetching addresses for customer:', customerId);
                    
                    try {
                        const response = await fetch(`/warranty-services/api/customers/${customerId}/addresses/`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            }
                        });

                        console.log('Addresses API Response status:', response.status);
                        const data = await response.json();
                        console.log('Addresses API Response data:', data);
                        
                        if (data.success) {
                            this.customerAddresses = data.addresses;
                            console.log('Found addresses:', data.addresses.length);
                            
                            // Auto-select first address if only one exists
                            if (data.addresses.length === 1) {
                                this.selectedAddress = data.addresses[0];
                                this.installation.location_address = data.addresses[0].full_address;
                                console.log('Auto-selected single address:', data.addresses[0].name);
                            }
                        } else {
                            this.customerAddresses = [];
                            console.log('API returned error:', data.message);
                        }
                    } catch (error) {
                        console.error('Customer addresses fetch error:', error);
                        this.customerAddresses = [];
                    }
                },

                selectAddress(address) {
                    this.selectedAddress = address;
                    this.installation.location_address = address.full_address;
                    console.log('Selected address:', address.name, '-', address.full_address);
                },

                showNewCustomerFormToggle() {
                    this.showNewCustomerForm = !this.showNewCustomerForm;
                    this.selectedCustomer = null;
                    this.customerSearch = '';
                    this.customerResults = [];
                },

                closeNewCustomerForm() {
                    this.showNewCustomerForm = false;
                    this.newCustomer = {
                        name: '',
                        email: '',
                        telephone: '',
                        contact_person: '',
                        contact_phone: '',
                        contact_email: '',
                        daily_working_hours: 8,
                        working_on_saturday: false,
                        working_on_sunday: false
                    };
                },

                getCurrentLocation() {
                    this.gettingLocation = true;
                    this.errorMessage = '';
                    
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                this.installation.latitude = position.coords.latitude.toString();
                                this.installation.longitude = position.coords.longitude.toString();
                                this.gettingLocation = false;
                                this.successMessage = 'Konum ba≈üarƒ±yla alƒ±ndƒ±!';
                                setTimeout(() => this.successMessage = '', 3000);
                            },
                            (error) => {
                                this.gettingLocation = false;
                                this.errorMessage = 'Konum alƒ±namadƒ±: ' + error.message;
                            }
                        );
                    } else {
                        this.gettingLocation = false;
                        this.errorMessage = 'Bu tarayƒ±cƒ± konum hizmetlerini desteklemiyor.';
                    }
                },

                addPhoto(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            this.photos.push({
                                file: file,
                                url: URL.createObjectURL(file),
                                name: file.name
                            });
                        }
                    });
                    event.target.value = '';
                },

                removePhoto(index) {
                    // Revoke object URL to free memory
                    if (this.photos[index] && this.photos[index].url) {
                        URL.revokeObjectURL(this.photos[index].url);
                    }
                    this.photos.splice(index, 1);
                },

                addFile(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        this.files.push(file);
                    });
                    event.target.value = '';
                },

                removeFile(index) {
                    this.files.splice(index, 1);
                },

                async submitForm() {
                    this.submitting = true;
                    this.errorMessage = '';
                    this.loadingMessage = 'Form g√∂nderiliyor...';
                    
                    try {
                        const formData = new FormData();
                        
                        // Item data
                        formData.append('item_id', this.item.id);
                        
                        // Customer data
                        if (this.selectedCustomer) {
                            formData.append('customer_id', this.selectedCustomer.id);
                        } else if (this.showNewCustomerForm) {
                            Object.keys(this.newCustomer).forEach(key => {
                                formData.append(`new_customer_${key}`, this.newCustomer[key]);
                            });
                        }
                        
                        // Installation data
                        Object.keys(this.installation).forEach(key => {
                            if (this.installation[key]) {
                                formData.append(key, this.installation[key]);
                            }
                        });
                        
                        // Photos
                        this.photos.forEach((photo, index) => {
                            formData.append(`photos`, photo);
                        });
                        
                        // Files
                        this.files.forEach((file, index) => {
                            formData.append(`files`, file);
                        });
                        
                        const response = await fetch('/warranty-services/api/service-form/create/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.successMessage = 'Form ba≈üarƒ±yla g√∂nderildi!';
                            setTimeout(() => {
                                window.location.href = '/warranty-services/installation/mobile/';
                            }, 2000);
                        } else {
                            this.errorMessage = result.message || 'Form g√∂nderilirken bir hata olu≈ütu.';
                        }
                    } catch (error) {
                        console.error('Form submission error:', error);
                        this.errorMessage = 'Form g√∂nderilirken bir hata olu≈ütu.';
                    } finally {
                        this.submitting = false;
                        this.loadingMessage = '';
                    }
                },

                getCsrfToken() {
                    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                },

                getCurrentDate() {
                    const now = new Date();
                    return now.toISOString().split('T')[0];
                },

                createCustomer() {
                    // Validate required fields
                    if (!this.newCustomer.name.trim()) {
                        this.showMessage('Firma adƒ± gereklidir', 'error');
                        return;
                    }

                    // Show loading
                    this.loading = true;
                    this.loadingMessage = 'M√º≈üteri olu≈üturuluyor...';

                    // Prepare data
                    const customerData = {
                        name: this.newCustomer.name.trim(),
                        email: this.newCustomer.email.trim(),
                        telephone: this.newCustomer.telephone.trim(),
                        contact_person: this.newCustomer.contact_person.trim(),
                        contact_phone: this.newCustomer.contact_phone.trim(),
                        contact_email: this.newCustomer.contact_email.trim(),
                        daily_working_hours: this.newCustomer.daily_working_hours,
                        working_on_saturday: this.newCustomer.working_on_saturday,
                        working_on_sunday: this.newCustomer.working_on_sunday
                    };

                    // Make API call
                    fetch('/warranty-services/api/customers/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(customerData)
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        console.log('Response headers:', response.headers);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        // Check if response is JSON
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            return response.text().then(text => {
                                console.log('Non-JSON response:', text);
                                throw new Error('Server returned non-JSON response');
                            });
                        }
                        
                        return response.json();
                    })
                    .then(data => {
                        this.loading = false;
                        this.loadingMessage = '';
                        
                        console.log('API response:', data);
                        
                        if (data.success) {
                            // Customer created successfully
                            this.selectedCustomer = data.customer;
                            
                            // Add new customer to search results for future searches
                            if (!this.customerResults.find(c => c.id === data.customer.id)) {
                                this.customerResults.unshift(data.customer);
                            }
                            
                            // Clear search query and hide results
                            this.customerSearch = data.customer.name;
                            this.showCustomerResults = false;
                            
                            this.showMessage(data.message, 'success');
                            this.closeNewCustomerForm();
                        } else {
                            this.showMessage(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        this.loadingMessage = '';
                        console.error('Error creating customer:', error);
                        this.showMessage('M√º≈üteri olu≈üturulurken bir hata olu≈ütu: ' + error.message, 'error');
                    });
                },

                async takePhoto() {
                    try {
                        // Check if camera is supported
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            this.showMessage('Kamera bu cihazda desteklenmiyor', 'error');
                            return;
                        }

                        // Create camera modal
                        const modal = document.createElement('div');
                        modal.innerHTML = `
                            <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                                <div class="bg-white rounded-lg p-4 max-w-sm w-full mx-4">
                                    <div class="text-center mb-4">
                                        <h3 class="text-lg font-semibold">Fotoƒüraf √áek</h3>
                                    </div>
                                    <video id="cameraVideo" class="w-full rounded-lg mb-4" autoplay playsinline></video>
                                    <canvas id="cameraCanvas" class="hidden"></canvas>
                                    <div class="flex gap-2">
                                        <button id="captureBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                                            <i class="fas fa-camera mr-2"></i>√áek
                                        </button>
                                        <button id="cancelCameraBtn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">
                                            ƒ∞ptal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);

                        const video = document.getElementById('cameraVideo');
                        const canvas = document.getElementById('cameraCanvas');
                        const captureBtn = document.getElementById('captureBtn');
                        const cancelBtn = document.getElementById('cancelCameraBtn');

                        // Start camera
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { 
                                facingMode: 'environment', // Back camera
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            }
                        });
                        
                        video.srcObject = stream;

                        // Capture photo
                        captureBtn.onclick = () => {
                            const context = canvas.getContext('2d');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            context.drawImage(video, 0, 0);
                            
                            canvas.toBlob(blob => {
                                const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                                this.photos.push({
                                    file: file,
                                    url: URL.createObjectURL(file),
                                    name: file.name
                                });
                                
                                // Stop camera and close modal
                                stream.getTracks().forEach(track => track.stop());
                                document.body.removeChild(modal);
                                
                                this.showMessage('Fotoƒüraf ba≈üarƒ±yla √ßekildi', 'success');
                            }, 'image/jpeg', 0.8);
                        };

                        // Cancel
                        cancelBtn.onclick = () => {
                            stream.getTracks().forEach(track => track.stop());
                            document.body.removeChild(modal);
                        };

                    } catch (error) {
                        console.error('Camera error:', error);
                        this.showMessage('Kamera a√ßƒ±lƒ±rken bir hata olu≈ütu: ' + error.message, 'error');
                    }
                },

                selectPhoto() {
                    // Create file input for gallery selection
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.multiple = true;
                    
                    input.onchange = (event) => {
                        const files = Array.from(event.target.files);
                        files.forEach(file => {
                            if (file.type.startsWith('image/')) {
                                this.photos.push({
                                    file: file,
                                    url: URL.createObjectURL(file),
                                    name: file.name
                                });
                            }
                        });
                        
                        if (files.length > 0) {
                            this.showMessage(`${files.length} fotoƒüraf se√ßildi`, 'success');
                        }
                    };
                    
                    input.click();
                },

                handleFileUpload(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        this.files.push(file);
                    });
                    event.target.value = '';
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                async submitInstallation() {
                    // Validate required fields
                    if (!this.selectedCustomer) {
                        this.showMessage('M√º≈üteri se√ßimi gereklidir', 'error');
                        return;
                    }

                    if (!this.installation.setup_date) {
                        this.showMessage('Kurulum tarihi gereklidir', 'error');
                        return;
                    }

                    // Show loading
                    this.submitting = true;
                    this.loadingMessage = 'Kurulum kaydediliyor...';

                    try {
                        // Prepare form data
                        const formData = new FormData();
                        
                        // Basic installation data
                        formData.append('item_id', this.item.id);
                        formData.append('customer_id', this.selectedCustomer.id);
                        formData.append('setup_date', this.installation.setup_date);
                        formData.append('setup_location', this.installation.location_address || '');
                        formData.append('installation_notes', this.installation.installation_notes || '');
                        formData.append('technician_notes', this.installation.technician_notes || '');
                        
                        // Selected address ID if available
                        if (this.selectedAddress && this.selectedAddress.id) {
                            formData.append('selected_address_id', this.selectedAddress.id);
                        }
                        
                        // Location data
                        if (this.installation.latitude && this.installation.longitude) {
                            formData.append('latitude', this.installation.latitude);
                            formData.append('longitude', this.installation.longitude);
                        }

                        // Add photos
                        this.photos.forEach((photo, index) => {
                            formData.append(`photo_${index}`, photo.file);
                        });

                        // Add files
                        this.files.forEach((file, index) => {
                            formData.append(`file_${index}`, file);
                        });

                        // CSRF token
                        formData.append('csrfmiddlewaretoken', this.getCsrfToken());

                        // Make API call
                        const response = await fetch('/warranty-services/api/installation/create/', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            this.showMessage('Kurulum ba≈üarƒ±yla kaydedildi!', 'success');
                            
                            // Wait a moment then redirect
                            setTimeout(() => {
                                window.location.href = '/warranty-services/installation/mobile/';
                            }, 2000);
                        } else {
                            this.showMessage(data.message || 'Kurulum kaydedilirken bir hata olu≈ütu', 'error');
                        }

                    } catch (error) {
                        console.error('Installation submission error:', error);
                        this.showMessage('Kurulum g√∂nderilirken bir hata olu≈ütu: ' + error.message, 'error');
                    } finally {
                        this.submitting = false;
                        this.loadingMessage = '';
                    }
                },

                showMessage(message, type = 'info') {
                    if (type === 'error') {
                        this.errorMessage = message;
                        setTimeout(() => this.errorMessage = '', 5000);
                    } else if (type === 'success') {
                        this.successMessage = message;
                        setTimeout(() => this.successMessage = '', 3000);
                    } else {
                        this.successMessage = message;
                        setTimeout(() => this.successMessage = '', 3000);
                    }
                }
            }))
        });
    </script>
</head>
<body class="h-full bg-gray-50" x-data="installationForm">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b sticky top-0 z-20">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button @click="goBack()" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div>
                            <h1 class="text-lg font-semibold text-gray-900">Installation Form</h1>
                            <p class="text-sm text-gray-500">Kurulum Bilgileri</p>
                        </div>
                    </div>
                    <button @click="showHelp = !showHelp" class="p-2 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="px-4 py-6 space-y-6">
            <!-- Selected Item Display -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-box text-blue-600 mr-2"></i>
                    Se√ßilen √úr√ºn
                </h2>
                <div class="space-y-3">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="text-sm text-blue-600 font-medium">{{ item.name.name }}</div>
                        <div class="text-xs text-blue-500">Seri No: {{ item.serial_no }}</div>
                    </div>
                    
                    <!-- Check if item is already installed -->
                    {% if item.in_used %}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-red-800">Kurulum Yapƒ±lamaz</p>
                                <p class="text-sm text-red-600">This item is already in use, it is not allowed to install</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Customer Selection -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user-tie text-green-600 mr-2"></i>
                    M√º≈üteri Se√ßimi
                </h2>
                
                <!-- Customer Search/Select -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            M√º≈üteri Ara
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                x-model="customerSearch"
                                @input="searchCustomers()"
                                placeholder="M√º≈üteri adƒ± veya firma adƒ±..."
                                class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Customer Results -->
                    <div x-show="showCustomerResults && customerResults.length > 0" class="space-y-2">
                        <template x-for="customer in customerResults" :key="customer.id">
                            <div @click="selectCustomer(customer)" 
                                 class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                                <div class="font-medium text-gray-900" x-text="customer.name"></div>
                                <div class="text-sm text-gray-500" x-text="customer.email || 'Email yok'"></div>
                                <div class="text-xs text-gray-400" x-text="customer.company_type_display"></div>
                            </div>
                        </template>
                    </div>

                    <!-- Selected Customer -->
                    <div x-show="selectedCustomer" class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-green-900" x-text="selectedCustomer?.name"></div>
                                <div class="text-sm text-green-700" x-text="selectedCustomer?.email"></div>
                            </div>
                            <button @click="clearCustomer()" class="text-green-600 hover:text-green-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- No Customer Found / New Customer Button -->
                    <div x-show="customerSearch && customerResults.length === 0 && !selectedCustomer" 
                         class="text-center py-4 border-2 border-dashed border-gray-300 rounded-lg">
                        <div class="text-gray-500 mb-3">M√º≈üteri bulunamadƒ±</div>
                        <button @click="showNewCustomerForm = true" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            Yeni M√º≈üteri Olu≈ütur
                        </button>
                    </div>

                    <!-- Always Visible New Customer Button -->
                    <div class="text-center py-2">
                        <button @click="showNewCustomerForm = true" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            Yeni M√º≈üteri Ekle
                        </button>
                    </div>
                </div>
            </div>

            <!-- New Customer Form (Collapsible) -->
            <div x-show="showNewCustomerForm" x-transition class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-user-plus text-blue-600 mr-2"></i>
                        Yeni M√º≈üteri Olu≈ütur
                    </h3>
                    <button @click="closeNewCustomerForm()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Company Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Firma Adƒ± *
                        </label>
                        <input 
                            type="text" 
                            x-model="newCustomer.name"
                            placeholder="Firma adƒ±nƒ± girin..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Email
                        </label>
                        <input 
                            type="email" 
                            x-model="newCustomer.email"
                            placeholder="Email adresini girin..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- Phone -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Telefon
                        </label>
                        <input 
                            type="tel" 
                            x-model="newCustomer.telephone"
                            placeholder="Telefon numarasƒ±nƒ± girin..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- Contact Person -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ƒ∞leti≈üim Ki≈üisi
                        </label>
                        <input 
                            type="text" 
                            x-model="newCustomer.contact_person"
                            placeholder="ƒ∞leti≈üim ki≈üisi adƒ±..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- Contact Phone -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ƒ∞leti≈üim Telefonu
                        </label>
                        <input 
                            type="tel" 
                            x-model="newCustomer.contact_phone"
                            placeholder="ƒ∞leti≈üim ki≈üisi telefon numarasƒ±..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- Contact Email -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ƒ∞leti≈üim Email
                        </label>
                        <input 
                            type="email" 
                            x-model="newCustomer.contact_email"
                            placeholder="ƒ∞leti≈üim ki≈üisi email adresi..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>

                    <!-- Working Hours Section -->
                    <div class="bg-blue-50 rounded-lg p-4 space-y-4">
                        <h4 class="text-md font-semibold text-blue-900 flex items-center">
                            <i class="fas fa-clock text-blue-600 mr-2"></i>
                            √áalƒ±≈üma Saatleri
                        </h4>
                        
                        <!-- Daily Working Hours -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                G√ºnl√ºk √áalƒ±≈üma Saati
                            </label>
                            <div class="relative">
                                <input 
                                    type="number" 
                                    x-model.number="newCustomer.daily_working_hours" 
                                    min="1" 
                                    max="24" 
                                    placeholder="8"
                                    class="w-full px-4 py-3 pr-16 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm text-gray-500">saat</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">G√ºnde maksimum 24 saat</p>
                        </div>
                        
                        <!-- Weekend Work -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Saturday Work -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Cumartesi √áalƒ±≈ümasƒ±</label>
                                <div class="flex items-center space-x-3">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" x-model="newCustomer.working_on_saturday" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 transition-all duration-300 peer-checked:bg-blue-600 relative">
                                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-all duration-300 peer-checked:translate-x-5"></div>
                                        </div>
                                        <span class="ml-3 text-sm text-gray-700" x-text="newCustomer.working_on_saturday ? '√áalƒ±≈üƒ±yor' : '√áalƒ±≈ümƒ±yor'"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Sunday Work -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Pazar √áalƒ±≈ümasƒ±</label>
                                <div class="flex items-center space-x-3">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" x-model="newCustomer.working_on_sunday" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 transition-all duration-300 peer-checked:bg-blue-600 relative">
                                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-all duration-300 peer-checked:translate-x-5"></div>
                                        </div>
                                        <span class="ml-3 text-sm text-gray-700" x-text="newCustomer.working_on_sunday ? '√áalƒ±≈üƒ±yor' : '√áalƒ±≈ümƒ±yor'"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weekly Summary -->
                        <div class="bg-white rounded-lg p-3 border border-blue-200">
                            <div class="text-sm text-blue-800">
                                <div class="flex justify-between">
                                    <span>Haftalƒ±k Toplam:</span>
                                    <span class="font-semibold" x-text="((newCustomer.daily_working_hours || 8) * 5 + ((newCustomer.working_on_saturday ? (newCustomer.daily_working_hours || 8) : 0) + (newCustomer.working_on_sunday ? (newCustomer.daily_working_hours || 8) : 0))) + ' saat'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>√áalƒ±≈üma G√ºn√º:</span>
                                    <span class="font-semibold" x-text="(5 + (newCustomer.working_on_saturday ? 1 : 0) + (newCustomer.working_on_sunday ? 1 : 0)) + ' g√ºn'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-3 pt-4">
                        <button @click="createCustomer()" 
                                :disabled="!newCustomer.name"
                                :class="!newCustomer.name ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                                class="flex-1 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            M√º≈üteriyi Kaydet
                        </button>
                        <button @click="closeNewCustomerForm()" 
                                class="px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            ƒ∞ptal
                        </button>
                    </div>
                </div>
            </div>

            <!-- Customer Address Selection -->
            <div x-show="selectedCustomer && customerAddresses.length > 0" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-map-marker-alt text-purple-600 mr-2"></i>
                    Kurulum Adresi Se√ßimi
                </h2>
                
                <div class="space-y-3">
                    <template x-for="address in customerAddresses" :key="address.id">
                        <div @click="selectAddress(address)" 
                             :class="selectedAddress?.id === address.id ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:bg-gray-50'"
                             class="p-4 border rounded-lg cursor-pointer transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900" x-text="address.name"></div>
                                    <div class="text-sm text-gray-600 mt-1" x-text="address.full_address"></div>
                                    <div x-show="address.zipcode" class="text-xs text-gray-500 mt-1">
                                        Posta Kodu: <span x-text="address.zipcode"></span>
                                    </div>
                                </div>
                                <div x-show="selectedAddress?.id === address.id" class="ml-3">
                                    <i class="fas fa-check-circle text-purple-600"></i>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Manual Address Entry Option -->
                    <div class="border-t pt-3 mt-4">
                        <button @click="selectedAddress = null; installation.location_address = ''" 
                                class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-edit mr-2"></i>
                            Farklƒ± adres gir
                        </button>
                    </div>
                </div>
            </div>

            <!-- Installation Details -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-tools text-orange-600 mr-2"></i>
                    Kurulum Detaylarƒ±
                </h2>
                
                <div class="space-y-4">
                    <!-- Setup Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Kurulum Tarihi *
                        </label>
                        <input 
                            type="date" 
                            x-model="installation.setup_date"
                            :max="getCurrentDate()"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                        <div class="text-xs text-gray-500 mt-1">
                            Kurulum tarihi bug√ºnden ileri olamaz
                        </div>
                    </div>

                    <!-- Installation Address -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Kurulum Adresi
                            <span x-show="selectedAddress" class="text-xs text-purple-600 ml-2">
                                (Se√ßili: <span x-text="selectedAddress?.name"></span>)
                            </span>
                        </label>
                        <textarea 
                            x-model="installation.location_address"
                            :placeholder="selectedAddress ? 'Se√ßili adres otomatik dolduruldu...' : 'Kurulum yapƒ±lacak adres...'"
                            :class="selectedAddress ? 'bg-purple-50 border-purple-200' : 'border-gray-300'"
                            rows="3"
                            class="w-full px-4 py-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                        <div x-show="!selectedAddress && selectedCustomer && customerAddresses.length > 0" 
                             class="text-xs text-blue-600 mt-1">
                            üí° Yukarƒ±dan m√º≈üteri adreslerinden birini se√ßebilirsiniz
                        </div>
                    </div>

                    <!-- GPS Location -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            GPS Konumu
                        </label>
                        <div class="space-y-2">
                            <button @click="getCurrentLocation()" 
                                    :disabled="gettingLocation"
                                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">
                                <i :class="gettingLocation ? 'fas fa-spinner fa-spin' : 'fas fa-map-marker-alt'" class="mr-2"></i>
                                <span x-text="gettingLocation ? 'Konum alƒ±nƒ±yor...' : 'Mevcut Konumu Al'"></span>
                            </button>
                            
                            <div x-show="installation.latitude && installation.longitude" 
                                 class="bg-green-50 border border-green-200 rounded-lg p-3">
                                <div class="text-sm text-green-800">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <i class="fas fa-check-circle mr-2"></i>
                                            <span>Konum ba≈üarƒ±yla alƒ±ndƒ±</span>
                                        </div>
                                        <button type="button" 
                                                @click="window.open(`https://maps.google.com/?q=${installation.latitude},${installation.longitude}`, '_blank')"
                                                class="text-blue-600 hover:text-blue-800 text-xs">
                                            <i class="fas fa-external-link-alt mr-1"></i>Haritada G√∂r
                                        </button>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        <span x-text="parseFloat(installation.latitude).toFixed(6)"></span>, 
                                        <span x-text="parseFloat(installation.longitude).toFixed(6)"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Installation Notes -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Kurulum Notlarƒ±
                        </label>
                        <textarea 
                            x-model="installation.notes"
                            placeholder="Kurulum ile ilgili √∂zel notlar..."
                            rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>

                    <!-- Fotoƒüraf ve Dosya Y√ºkleme -->
                    <div class="space-y-4">
                        <!-- Fotoƒüraf √áekme -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-camera mr-2"></i>Fotoƒüraf √áek
                            </label>
                            <div class="flex space-x-2">
                                <button 
                                    type="button"
                                    @click="takePhoto()"
                                    class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <i class="fas fa-camera mr-2"></i>Kamera A√ß
                                </button>
                                <button 
                                    type="button"
                                    @click="selectPhoto()"
                                    class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <i class="fas fa-image mr-2"></i>Galeri
                                </button>
                            </div>
                        </div>

                        <!-- Fotoƒüraf √ñnizleme -->
                        <div x-show="photos.length > 0" class="grid grid-cols-2 gap-2">
                            <template x-for="(photo, index) in photos" :key="index">
                                <div class="relative">
                                    <img :src="photo.url" :alt="'Fotoƒüraf ' + (index + 1)" class="w-full h-32 object-cover rounded-lg border">
                                    <button 
                                        type="button"
                                        @click="removePhoto(index)"
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                                        √ó
                                    </button>
                                    <div class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-1 rounded">
                                        <span x-text="photo.name"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Dosya Y√ºkleme -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-file mr-2"></i>Dosya Ekle
                            </label>
                            <input 
                                type="file" 
                                @change="handleFileUpload($event)"
                                multiple
                                accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                                class="hidden"
                                x-ref="fileInput">
                            <button 
                                type="button"
                                @click="$refs.fileInput.click()"
                                class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                <i class="fas fa-paperclip mr-2"></i>Dosya Se√ß
                            </button>
                        </div>

                        <!-- Dosya Listesi -->
                        <div x-show="files.length > 0" class="space-y-2">
                            <template x-for="(file, index) in files" :key="index">
                                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-file mr-2 text-gray-500"></i>
                                        <span class="text-sm" x-text="file.name"></span>
                                        <span class="text-xs text-gray-500 ml-2" x-text="formatFileSize(file.size)"></span>
                                    </div>
                                    <button 
                                        type="button"
                                        @click="removeFile(index)"
                                        class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pb-8">
                <button @click="submitInstallation()" 
                        :disabled="!selectedCustomer || !installation.setup_date || submitting"
                        :class="(!selectedCustomer || !installation.setup_date || submitting) ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                        class="w-full text-white py-4 px-6 rounded-lg font-semibold text-lg transition-colors">
                    <i :class="submitting ? 'fas fa-spinner fa-spin' : 'fas fa-check'" class="mr-2"></i>
                    <span x-text="submitting ? 'Kurulum kaydediliyor...' : 'Kurulumu Tamamla'"></span>
                </button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span class="text-gray-700" x-text="loadingMessage"></span>
            </div>
        </div>

        <!-- Error Message -->
        <div x-show="errorMessage" class="fixed top-4 left-4 right-4 bg-red-50 border border-red-200 rounded-lg p-4 z-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                    <p class="text-red-800" x-text="errorMessage"></p>
                </div>
                <button @click="errorMessage = ''" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Success Message -->
        <div x-show="successMessage" class="fixed top-4 left-4 right-4 bg-green-50 border border-green-200 rounded-lg p-4 z-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 mr-3"></i>
                    <p class="text-green-800" x-text="successMessage"></p>
                </div>
                <button @click="successMessage = ''" class="text-green-600 hover:text-green-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Help Modal -->
        <div x-show="showHelp" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Yardƒ±m</h3>
                    <button @click="showHelp = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-3 text-sm text-gray-600">
                    <p><strong>M√º≈üteri Se√ßimi:</strong> Mevcut m√º≈üteriyi arayƒ±n veya yeni m√º≈üteri olu≈üturun.</p>
                    <p><strong>Kurulum Tarihi:</strong> Kurulumun yapƒ±ldƒ±ƒüƒ± tarih ve saati girin.</p>
                    <p><strong>GPS Konumu:</strong> Otomatik konum almak i√ßin "Mevcut Konumu Al" butonunu kullanƒ±n.</p>
                    <p><strong>Kurulum Notlarƒ±:</strong> √ñzel durumlar veya dikkat edilmesi gereken noktalarƒ± yazƒ±n.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF Token -->
    {% csrf_token %}
</body>
</html>
