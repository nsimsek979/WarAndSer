{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalabl            try {
                let qrJson = JSON.parse(qrResult);
                let searchTerm = '';
                
                if (qrJson.serial_no) {
                    searchTerm = qrJson.serial_no;
                } else if (qrJson.serial_number) {
                    searchTerm = qrJson.serial_number;
                } else if (qrJson.serialNumber) {
                    searchTerm = qrJson.serialNumber;
                } else {
                    searchTerm = qrResult; // Use raw QR result if no serial found
                }
                
                // Fill manual entry field
                const serialInput = document.querySelector('input[type="text"]');
                if (serialInput) {
                    serialInput.value = searchTerm;
                }
                
                // Auto-search for installed items
                searchInstalledItems(searchTerm);
            } catch (e) {
                // QR data is plain text, use as is
                const serialInput = document.querySelector('input[type="text"]');
                if (serialInput) {
                    serialInput.value = qrResult;
                }
                searchInstalledItems(qrResult);
            }ttp-equiv="X-UA-Compatible" content="IE=edge">
    <title>{% trans "Maintenance Scanner - GVS Mobile" %}</title>
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'konnektom-logo.png' %}">

    <!-- Tailwind CSS -->
    <link href="{% static 'css/tailwind.css' %}" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .mobile-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .mobile-card:active {
            transform: scale(0.98);
        }
        
        .header-bg {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .scanner-area {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 2px dashed #10b981;
        }
    </style>
</head>

<body class="h-full bg-gray-50 pb-20">
    <!-- Header -->
    <div class="header-bg text-white shadow-lg">
        <div class="px-4 py-6 pt-12">
            <div class="flex items-center space-x-3">
                <a href="{% url 'warranty_and_services:mobile_main' %}" 
                   class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center hover:bg-white/30 transition-colors">
                    <i class="fas fa-arrow-left text-white"></i>
                </a>
                <div>
                    <h1 class="text-lg font-bold">{% trans "Maintenance Scanner" %}</h1>
                    <p class="text-white/80 text-sm">{% trans "QR Code Maintenance" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-6 space-y-6">
        <!-- Scanner Area -->
        <div class="scanner-area rounded-xl p-8 text-center mobile-card">
            <!-- Camera Preview -->
            <div id="cameraPreview" class="w-full h-64 bg-black rounded-lg mb-4 relative overflow-hidden" style="display: none;">
                <video id="video" class="w-full h-full object-cover"></video>
                <div class="absolute inset-0 border-2 border-green-500 rounded-lg pointer-events-none"></div>
                <canvas id="canvas" style="display: none;"></canvas>
            </div>
            
            <!-- Default Scanner UI -->
            <div id="scannerUI">
                <div class="w-24 h-24 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-qrcode text-green-600 text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-900 mb-2">{% trans "Scan QR Code" %}</h2>
                <p class="text-gray-600 mb-6">{% trans "Hold the equipment's QR code up to the camera" %}</p>
            </div>
            
            <button id="startCamera" class="w-full bg-green-600 text-white py-4 rounded-xl font-semibold hover:bg-green-700 transition-colors mobile-card">
                <i class="fas fa-camera mr-2"></i>
                <span id="cameraButtonText">{% trans "Start Camera" %}</span>
            </button>
        </div>

        <!-- Manual Search -->
        <div class="bg-white rounded-xl p-6 mobile-card">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{% trans "Search Installed Equipment" %}</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Serial No / Barcode" %}</label>
                    <input type="text" placeholder="{% trans 'Enter serial number or barcode' %}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">{% trans "Only installed equipment will be searched" %}</p>
                </div>
                
                <button id="manualSearchBtn" class="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    {% trans "Search Equipment" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    {% include 'warranty_and_services/mobile/mobile_nav.html' %}

    <!-- QR Code Scanner Script -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script>
        let cameraStarted = false;
        let html5QrCode = null;

        document.getElementById('startCamera').addEventListener('click', function() {
            if (!cameraStarted) {
                startQRScanner();
            } else {
                stopQRScanner();
            }
        });

        function startQRScanner() {
            const cameraPreview = document.getElementById('cameraPreview');
            const scannerUI = document.getElementById('scannerUI');
            const button = document.getElementById('startCamera');
            const buttonText = document.getElementById('cameraButtonText');

            // Show camera preview
            cameraPreview.style.display = 'block';
            scannerUI.style.display = 'none';
            
            // Update button
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-red-600', 'hover:bg-red-700');
            buttonText.innerHTML = '<i class="fas fa-stop mr-2"></i>{% trans "Stop Camera" %}';

            // Start QR Code scanner
            html5QrCode = new Html5Qrcode("cameraPreview");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" }, // Use back camera
                config,
                (decodedText, decodedResult) => {
                    console.log(`QR Code detected: ${decodedText}`);
                    
                    // Stop scanner
                    stopQRScanner();
                    
                    // Process QR code
                    processQRCode(decodedText);
                },
                (errorMessage) => {
                    // QR code not found, continue scanning
                }
            ).catch(err => {
                console.error('Camera error:', err);
                showError('{% trans "Camera access failed. Please check camera permissions." %}');
                resetUI();
            });

            cameraStarted = true;
        }

        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    resetUI();
                }).catch(err => {
                    console.error('Stop error:', err);
                    resetUI();
                });
            }
        }

        function resetUI() {
            const cameraPreview = document.getElementById('cameraPreview');
            const scannerUI = document.getElementById('scannerUI');
            const button = document.getElementById('startCamera');
            const buttonText = document.getElementById('cameraButtonText');

            // Hide camera preview
            cameraPreview.style.display = 'none';
            scannerUI.style.display = 'block';
            
            // Reset button
            button.classList.remove('bg-red-600', 'hover:bg-red-700');
            button.classList.add('bg-green-600', 'hover:bg-green-700');
            buttonText.innerHTML = '<i class="fas fa-camera mr-2"></i>{% trans "Start Camera" %}';

            cameraStarted = false;
        }

        function processQRCode(qrData) {
            // Show loading
            showMessage('{% trans "QR code read, searching for installed equipment..." %}', 'info');
            
            // Try to extract serial number or item info from QR code
            let searchTerm = qrData;
            
            // If QR contains JSON or structured data, try to parse it
            try {
                const qrJson = JSON.parse(qrData);
                if (qrJson.serial_number) {
                    searchTerm = qrJson.serial_number;
                } else if (qrJson.serialNumber) {
                    searchTerm = qrJson.serialNumber;
                } else if (qrJson.serial_no) {
                    searchTerm = qrJson.serial_no;
                }
            } catch (e) {
                // QR data is plain text, use as is
                searchTerm = qrData;
            }
            
            // Fill manual entry field
            const serialInput = document.querySelector('input[type="text"]');
            if (serialInput) {
                serialInput.value = searchTerm;
            }
            
            // Auto-search for installed items
            searchInstalledItems(searchTerm);
        }

        function searchInstalledItems(searchTerm) {
            console.log('searchInstalledItems fonksiyonu çağrıldı, searchTerm:', searchTerm);
            
            if (!searchTerm) {
                showError('{% trans "Search term required" %}');
                return;
            }

            showMessage('{% trans "Searching for installed equipment..." %}', 'info');

            // Call maintenance search API
            fetch('{% url "warranty_and_services:api_maintenance_search" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    search_term: searchTerm
                })
            })
            .then(response => {
                console.log('API yanıtı alındı, status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API data:', data);
                if (data.success) {
                    if (data.results.length === 1) {
                        console.log('Tek sonuç bulundu, showMaintenanceDetail çağrılıyor');
                        // Tek sonuç varsa direkt detaya git
                        showMaintenanceDetail(data.results[0]);
                    } else if (data.results.length > 1) {
                        console.log('Birden fazla sonuç bulundu, liste gösteriliyor');
                        // Birden fazla sonuç varsa liste göster
                        showSearchResults(data.results);
                    } else {
                        console.log('Hiç sonuç bulunamadı');
                        showError('{% trans "No installed equipment found" %}');
                    }
                } else {
                    console.log('API success=false döndü:', data.message);
                    showError(data.message || '{% trans "No installed equipment found" %}');
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                showError('{% trans "An error occurred during search" %}');
            });
        }

        function showSearchResults(results) {
            // Create results modal or update UI to show results
            let resultsHtml = '<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">';
            resultsHtml += '<div class="bg-white rounded-xl max-w-2xl w-full max-h-96 overflow-y-auto">';
            resultsHtml += '<div class="p-6">';
            resultsHtml += '<div class="flex justify-between items-center mb-4">';
            resultsHtml += '<h3 class="text-lg font-semibold">Bulunan Ekipmanlar (' + results.length + ')</h3>';
            resultsHtml += '<button onclick="closeSearchResults()" class="text-gray-500 hover:text-gray-700">';
            resultsHtml += '<i class="fas fa-times"></i></button></div>';
            
            results.forEach(result => {
                resultsHtml += '<div class="border rounded-lg p-4 mb-3 cursor-pointer hover:bg-gray-50" onclick="showMaintenanceDetail(' + JSON.stringify(result).replace(/"/g, '&quot;') + ')">';
                resultsHtml += '<div class="flex justify-between items-start">';
                resultsHtml += '<div class="flex-1">';
                resultsHtml += '<h4 class="font-semibold text-gray-900">' + result.item_name + '</h4>';
                resultsHtml += '<p class="text-sm text-gray-600">Seri No: ' + result.serial_no + '</p>';
                resultsHtml += '<p class="text-sm text-gray-600">Müşteri: ' + result.customer_name + '</p>';
                resultsHtml += '<p class="text-sm text-gray-500">Kurulum: ' + result.installation_date + '</p>';
                resultsHtml += '</div>';
                resultsHtml += '<div class="text-right">';
                resultsHtml += '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Kurulumu Yapılmış</span>';
                resultsHtml += '</div></div></div>';
            });
            
            resultsHtml += '</div></div></div>';
            
            // Add to body
            const resultsModal = document.createElement('div');
            resultsModal.id = 'searchResultsModal';
            resultsModal.innerHTML = resultsHtml;
            document.body.appendChild(resultsModal);
        }

        function closeSearchResults() {
            const modal = document.getElementById('searchResultsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function showMaintenanceDetail(result) {
            console.log('showMaintenanceDetail çağrıldı, result:', result);
            
            // Close search results if open
            closeSearchResults();
            
            // Show loading
            showMessage('Ekipman detayları alınıyor...', 'info');
            
            // Get detailed information about the installation
            fetch('{% url "warranty_and_services:api_maintenance_item_detail" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    installation_id: result.installation_id
                })
            })
            .then(response => {
                console.log('Maintenance detail API yanıtı:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Maintenance detail data:', data);
                if (data.success) {
                    // Redirect to maintenance form with installation ID
                    window.location.href = "{% url 'warranty_and_services:mobile_maintenance_form' %}?installation_id=" + result.installation_id;
                } else {
                    showError(data.message || '{% trans "Unable to get detail information" %}');
                }
            })
            .catch(error => {
                console.error('Detail error:', error);
                showError('{% trans "An error occurred while getting detail information" %}');
            });
        }

        function showMessage(message, type = 'info') {
            // Create toast message
            const toast = document.createElement('div');
            toast.className = `fixed top-4 left-4 right-4 p-4 rounded-lg z-50 text-white transform -translate-y-full transition-transform duration-300`;
            
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-blue-600');
            }
            
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.remove('-translate-y-full');
            }, 100);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('-translate-y-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        // Manual search functionality
        document.getElementById('manualSearchBtn').addEventListener('click', function() {
            console.log('Ekipman Ara butonuna tıklandı');
            const serialInput = document.querySelector('input[type="text"]');
            const searchTerm = serialInput.value.trim();
            
            console.log('Arama terimi:', searchTerm);
            
            if (searchTerm) {
                searchInstalledItems(searchTerm);
            } else {
                showError('{% trans "Please enter a serial number or barcode" %}');
            }
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
