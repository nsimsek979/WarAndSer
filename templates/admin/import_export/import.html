{% extends "admin/base_site.html" %}
{% load i18n admin_urls static import_export_tags %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{% static "admin/js/core.js" %}"></script>
<script type="text/javascript" src="{% static "import_export/guess_format.js" %}"></script>
<script type="text/javascript">
// Force file input to work properly
document.addEventListener('DOMContentLoaded', function() {
    var fileInput = document.getElementById('id_import_file');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            var fileName = e.target.files[0] ? e.target.files[0].name : '';
            console.log('File selected:', fileName);
        });
    }
});
</script>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

{% if confirm_form %}
    <form action="" method="post">
        {% csrf_token %}
        {% for field in confirm_form %}
            {% if field.is_hidden %}
                {{ field }}
            {% endif %}
        {% endfor %}

        <div class="module aligned">
            <h2>{% trans "Confirm import" %}</h2>
            <p>{% trans "Below is a preview of data to be imported. If you are satisfied with the results, click 'Confirm import'." %}</p>
            
            {% if result.has_errors %}
                <div class="errors">
                    <h3>{% trans "Errors" %}</h3>
                    {{ result.html_error_summary }}
                </div>
            {% endif %}

            {% if result.valid_rows %}
                <h3>{% trans "Preview" %}</h3>
                {{ result.html_preview }}
            {% endif %}

            <div class="submit-row">
                <input type="submit" value="{% trans "Confirm import" %}" class="default" name="confirm">
                <a href="{% url opts|admin_urlname:'changelist' %}" class="button cancel-link">{% trans "Cancel" %}</a>
            </div>
        </div>
    </form>

{% else %}
    <form action="" method="post" enctype="multipart/form-data" class="module aligned">
        {% csrf_token %}

        <div class="form-row">
            <div>
                <label for="id_import_file" class="required">{% trans "File to import:" %}</label>
                <input type="file" name="import_file" accept=".csv,.xls,.xlsx,.tsv,.json" required id="id_import_file" style="margin-left: 10px;">
                <p class="help">{% trans "Choose a file to upload" %}</p>
            </div>
        </div>

        <div class="form-row">
            <div>
                <label for="id_input_format">{% trans "Format:" %}</label>
                <select name="input_format" id="id_input_format">
                    {% for choice in formats %}
                        <option value="{{ choice.0 }}"{% if choice.0 == default_format %} selected{% endif %}>{{ choice.1 }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="submit-row">
            <input type="submit" value="{% trans "Submit" %}" class="default" name="submit">
        </div>
    </form>
{% endif %}

{% endblock %}
