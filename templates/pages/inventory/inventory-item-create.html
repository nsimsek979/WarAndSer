{% extends "base.html" %}
{% load static %}   
{% load i18n %}
{% load static %}

{% block title %}{% trans 'Create New Inventory Item' %}{% endblock %}
{% block page_title %}{% trans "Create Inventory Item" %}{% endblock %}
{% block page_description %}{% trans "Add a new item to inventory" %}{% endblock %}
{% block content %}
<div class="pl-8 pr-8 space-y-6">

    <!-- Messages -->
    {% if messages %}
    <div class="space-y-2">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %} px-4 py-3 rounded-md">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Tabbed Create Form -->
    <div x-data="{
        activeTab: 'basic',
        attributesData: [],
        availableUnits: {},
        selectedItemMaster: null,
        addAttribute() {
            this.attributesData.push({
                id: Date.now(),
                attribute_type: '',
                value: '',
                unit: ''
            });
        },
        removeAttribute(index) {
            this.attributesData.splice(index, 1);
        },
        async updateUnitsForAttribute(index, attributeTypeId, isInitialLoad = false) {
            if (!attributeTypeId) {
                this.attributesData[index].unit = '';
                return;
            }
            
            try {
                const response = await fetch(`/item-master/ajax/get-attribute-units/?attribute_type_id=${attributeTypeId}`);
                const data = await response.json();
                this.availableUnits[attributeTypeId] = data.units || [];
                
                // Reset unit if current unit is not compatible
                const currentUnit = this.attributesData[index].unit;
                if (currentUnit) {
                    const isCompatible = data.units.some(unit => unit.id == currentUnit);
                    if (!isCompatible) {
                        this.attributesData[index].unit = '';
                    }
                }
                
                // If no unit is selected AND this is NOT initial load, try to set default unit
                if (!this.attributesData[index].unit && !isInitialLoad) {
                    const defaultUnit = data.units.find(unit => unit.is_default);
                    if (defaultUnit) {
                        this.attributesData[index].unit = defaultUnit.id;
                    }
                }
            } catch (error) {
                console.error('Error fetching units:', error);
                this.availableUnits[attributeTypeId] = [];
            }
        },
        getAvailableUnits(attributeTypeId) {
            return this.availableUnits[attributeTypeId] || [];
        },
        updateSelectedItemMaster(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (selectedOption.value) {
                this.selectedItemMaster = {
                    id: selectedOption.value,
                    name: selectedOption.dataset.name,
                    shortcode: selectedOption.dataset.shortcode,
                    category: selectedOption.dataset.category,
                    brand: selectedOption.dataset.brand
                };
            } else {
                this.selectedItemMaster = null;
            }
        }
    }" class="bg-white rounded-xl border border-gray-200">
        
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
            <div class="flex justify-between items-center px-6 pt-4">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button @click="activeTab = 'basic'" 
                            :class="activeTab === 'basic' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        {% trans "Basic Info" %}
                    </button>
                    <button @click="activeTab = 'attributes'"
                            :class="activeTab === 'attributes' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        {% trans "Attributes" %}
                    </button>
                </nav>
                <div class="pb-2">
                    <a href="{% url 'item-master:inventory_item_list' %}" class="inline-flex items-center space-x-2
                             bg-gray-100 text-gray-700 border border-gray-200 px-3 py-1.5 rounded-md hover:bg-gray-200 text-sm">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>{% trans "Back to List" %}</span>
                    </a>
                </div>
            </div>
        </div>

        <form method="post" class="p-6">
            {% csrf_token %}
            
            <!-- Tab 1: Basic Information -->
            <div x-show="activeTab === 'basic'" class="space-y-4">
                
                <!-- Item Master Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="item_master" class="block text-xs font-medium text-gray-700 mb-1">
                            {% trans "Item Master" %} <span class="text-red-500">*</span>
                        </label>
                        <select id="item_master" 
                                name="item_master" 
                                @change="updateSelectedItemMaster($event.target)"
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                required>
                            <option value="">{% trans "Select an item master" %}</option>
                            {% for item in item_masters %}
                            <option value="{{ item.id }}" 
                                    data-name="{{ item.name|escapejs }}" 
                                    data-shortcode="{{ item.shortcode|escapejs }}" 
                                    data-category="{{ item.category.category_name|default:'-'|escapejs }}" 
                                    data-brand="{{ item.brand_name.name|default:'-'|escapejs }}"
                                    {% if request.POST.item_master == item.id|stringformat:"s" %}selected{% endif %}>
                                {{ item.shortcode }} - {{ item.name }}
                            </option>
                            {% empty %}
                            <option value="" disabled>{% trans "No active item masters found" %}</option>
                            {% endfor %}
                        </select>
                        <!-- Debug information -->
                        <p class="text-xs text-gray-500 mt-1">
                            {% trans "Available items" %}: {{ item_masters|length }}
                        </p>
                    </div>
                    
                    <!-- Selected Item Master Display -->
                    <div x-show="selectedItemMaster" class="md:col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-semibold text-blue-900 mb-2">{% trans "Selected Item Master" %}</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div>
                                <span class="text-blue-700 font-medium">{% trans "Shortcode" %}:</span>
                                <span x-text="selectedItemMaster?.shortcode" class="text-blue-900"></span>
                            </div>
                            <div>
                                <span class="text-blue-700 font-medium">{% trans "Name" %}:</span>
                                <span x-text="selectedItemMaster?.name" class="text-blue-900"></span>
                            </div>
                            <div>
                                <span class="text-blue-700 font-medium">{% trans "Category" %}:</span>
                                <span x-text="selectedItemMaster?.category" class="text-blue-900"></span>
                            </div>
                            <div>
                                <span class="text-blue-700 font-medium">{% trans "Brand" %}:</span>
                                <span x-text="selectedItemMaster?.brand" class="text-blue-900"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Serial Number -->
                    <div>
                        <label for="serial_no" class="block text-sm font-medium text-gray-700 mb-1">
                            {% trans "Serial Number" %}
                        </label>
                        <input type="text" 
                               id="serial_no" 
                               name="serial_no" 
                               value="{{ request.POST.serial_no }}"
                               class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="{% trans 'Enter serial number' %}"
                               maxlength="100">
                    </div>

                    <!-- In Used -->
                    <div class="flex items-center">
                        <input type="checkbox" 
                               id="in_used" 
                               name="in_used" 
                               {% if request.POST.in_used %}checked{% endif %}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="in_used" class="ml-2 block text-sm font-medium text-gray-700">
                            {% trans "Currently in use" %}
                        </label>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Attributes -->
            <div x-show="activeTab === 'attributes'" class="space-y-4">
                <div class="flex justify-end items-center">
                    <button type="button" 
                            @click="addAttribute()"
                            class="inline-flex items-center space-x-1 px-3 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>{% trans "Add Attribute" %}</span>
                    </button>
                </div>

                <!-- Attributes List -->
                <div class="space-y-3">
                    <template x-if="attributesData.length === 0">
                        <div class="text-center py-8 text-gray-500">
                            {% trans "No attributes added yet. Click 'Add Attribute' to add item-specific attributes." %}
                        </div>
                    </template>
                    
                    <template x-for="(attribute, index) in attributesData" :key="attribute.id">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-4 bg-gray-50 rounded-lg border">
                            <!-- Attribute Type -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">{% trans "Attribute Type" %}</label>
                                <select :name="'attribute_type'" 
                                        x-model="attribute.attribute_type"
                                        @change="updateUnitsForAttribute(index, $event.target.value, false)"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">{% trans "Select type" %}</option>
                                    {% for attr_type in attribute_types %}
                                    <option value="{{ attr_type.id }}">{{ attr_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Value -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Value" %}</label>
                                <input type="text" 
                                       :name="'attribute_value'" 
                                       x-model="attribute.value"
                                       class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="{% trans 'Enter value' %}">
                            </div>
                            
                            <!-- Unit -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Unit" %}</label>
                                <select :name="'attribute_unit'" 
                                        x-model="attribute.unit"
                                        :disabled="!attribute.attribute_type"
                                        class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">{% trans "Select unit" %}</option>
                                    <template x-for="unit in getAvailableUnits(attribute.attribute_type)">
                                        <option :value="unit.id" x-text="unit.name + ' (' + unit.symbol + ')'"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <!-- Remove Button -->
                            <div class="flex items-end">
                                <button type="button" 
                                        @click="removeAttribute(index)"
                                        class="w-full px-3 py-2 text-sm text-red-600 rounded-md hover:bg-gray-100 flex items-center justify-center"
                                        title="{% trans 'Remove Attribute' %}">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                <div class="flex space-x-2">
                    <button type="button" 
                            @click="activeTab = 'basic'"
                            x-show="activeTab !== 'basic'"
                            class="px-4 py-2 text-sm border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                        {% trans "Previous" %}
                    </button>
                    <button type="button" 
                            @click="activeTab = 'attributes'"
                            x-show="activeTab === 'basic'"
                            class="px-4 py-2 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700">
                        {% trans "Next" %}
                    </button>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'item-master:inventory_item_list' %}" 
                       class="px-4 py-2 text-sm border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                        {% trans "Cancel" %}
                    </a>
                    <button type="submit" 
                            class="px-4 py-2 text-sm bg-blue-700 text-white rounded-md hover:bg-blue-800">
                        {% trans "Create Inventory Item" %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus on item master selection
    const itemMasterField = document.getElementById('item_master');
    if (itemMasterField) {
        itemMasterField.focus();
    }
});
</script>
{% endblock %}
