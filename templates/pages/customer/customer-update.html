{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans 'Update Customer' %}- {{ company.name }}{% endblock %}

{% block page_title %}{% trans "Update Customer" %}{% endblock %}
{% block page_description %}{{ company.name }}{% endblock %}

{% block content %}
<div x-data="customerForm()" x-init="init()" class="max-w-5xl mx-auto mt-8 bg-white rounded-xl shadow p-8">
  {# Inject JSON data for Alpine.js initialization #}
  {{ managers|json_script:"managers-data" }}
  {{ core_businesses|json_script:"core-businesses-data" }}
  {{ countries|json_script:"countries-data" }}
  {{ companies|json_script:"companies-data" }}
  {{ contacts|json_script:"contacts-data" }}
  {{ addresses|json_script:"addresses-data" }}
  {{ company_data|json_script:"company-data" }}
  {{ working_hours|json_script:"working-hours-data" }}
  <script id="user-context-data" type="application/json">
    {
      "is_distributor_user": {% if is_distributor_user %}true{% else %}false{% endif %},
      "default_related_manager_id": {% if default_related_manager_id %}"{{ default_related_manager_id }}"{% else %}null{% endif %}
    }
  </script>
  <script id="company-data" type="application/json">
    {
      "name": "{{ company.name|escapejs }}",
      "company_type": "{{ company.company_type|escapejs }}",
      "core_business": {% if company.core_business %}"{{ company.core_business.id }}"{% else %}null{% endif %},
      "related_company": {% if company.related_company %}"{{ company.related_company.id }}"{% else %}null{% endif %},
      "related_manager": {% if company.related_manager %}"{{ company.related_manager.id }}"{% else %}null{% endif %},
      "email": "{{ company.email|default:""|escapejs }}",
      "telephone": "{{ company.telephone|default:""|escapejs }}",
      "active": {% if company.active %}true{% else %}false{% endif %}
    }
  </script>
  <script id="working-hours-data" type="application/json">
    {% if company.working_hours %}
    {
      "daily_working_hours": {{ company.working_hours.daily_working_hours }},
      "working_on_saturday": {% if company.working_hours.working_on_saturday %}true{% else %}false{% endif %},
      "working_on_sunday": {% if company.working_hours.working_on_sunday %}true{% else %}false{% endif %}
    }
    {% else %}
    {
      "daily_working_hours": 8,
      "working_on_saturday": false,
      "working_on_sunday": false
    }
    {% endif %}
  </script>

  <!-- Form -->
  <form method="post" id="customer-update-form" @submit="confirmUpdate">
    {% csrf_token %}
    
    <!-- Hidden form fields for Alpine.js data submission -->
    <input type="hidden" name="name" x-model="form.name">
    <input type="hidden" name="company_type" x-model="form.company_type">
    <input type="hidden" name="core_business" x-model="form.core_business">
    <input type="hidden" name="related_company" x-model="form.related_company">
    <input type="hidden" name="related_manager" x-model="form.related_manager">
    <input type="hidden" name="email" x-model="form.email">
    <input type="hidden" name="telephone" x-model="form.telephone">
    <input type="hidden" name="active" :value="form.active ? '1' : '0'">
    
    <!-- Dynamic contact fields -->
    <template x-for="(contact, index) in form.contacts" :key="index">
      <div>
        <input type="hidden" :name="`contacts[${index}][full_name]`" x-model="contact.full_name">
        <input type="hidden" :name="`contacts[${index}][title]`" x-model="contact.title">
        <input type="hidden" :name="`contacts[${index}][email]`" x-model="contact.email">
        <input type="hidden" :name="`contacts[${index}][telephone]`" x-model="contact.telephone">
      </div>
    </template>
    
    <!-- Dynamic address fields -->
    <template x-for="(address, index) in form.addresses" :key="index">
      <div>
        <input type="hidden" :name="`addresses[${index}][name]`" x-model="address.name">
        <input type="hidden" :name="`addresses[${index}][country]`" x-model="address.country">
        <input type="hidden" :name="`addresses[${index}][city]`" x-model="address.city">
        <input type="hidden" :name="`addresses[${index}][county]`" x-model="address.county">
        <input type="hidden" :name="`addresses[${index}][district]`" x-model="address.district">
        <input type="hidden" :name="`addresses[${index}][zipcode]`" x-model="address.zipcode">
        <input type="hidden" :name="`addresses[${index}][address]`" x-model="address.address">
      </div>
    </template>
    
    <!-- Hidden fields for working hours -->
    <input type="hidden" name="daily_working_hours" x-model="form.working_hours.daily_working_hours">
    <input type="hidden" name="working_on_saturday" :value="form.working_hours.working_on_saturday ? '1' : '0'">
    <input type="hidden" name="working_on_sunday" :value="form.working_hours.working_on_sunday ? '1' : '0'">

    <!-- Tab Navigation -->
    <div class="border-b border-gray-200 mb-6">
      <div class="flex justify-between items-center">
        <nav class="-mb-px flex space-x-8">
          <button type="button" @click="activeTab = 'general'" 
                  :class="activeTab === 'general' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                  class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            {% trans 'General Information' %}
          </button>
          <button type="button" @click="activeTab = 'contacts'" 
                  :class="activeTab === 'contacts' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                  class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            {% trans 'Contacts' %} <span x-text="`(${form.contacts.length})`" class="text-xs"></span>
          </button>
          <button type="button" @click="activeTab = 'addresses'" 
                  :class="activeTab === 'addresses' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                  class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            {% trans 'Addresses' %} <span x-text="`(${form.addresses.length})`" class="text-xs"></span>
          </button>
          <button type="button" @click="activeTab = 'working_hours'" 
                  :class="activeTab === 'working_hours' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                  class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
            {% trans 'Working Hours' %}
          </button>
        </nav>
        <div class="pb-4">
          <a href="{% url 'customer:customer_detail' company.pk %}" class="inline-flex items-center space-x-2
                   bg-gray-100 text-gray-700 border border-gray-200 px-3 py-1.5 rounded-md hover:bg-gray-200 text-sm">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>{% trans "Cancel" %}</span>
          </a>
        </div>
      </div>
    </div>

    <!-- General Information Tab -->
    <div x-show="activeTab === 'general'" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Company Name -->
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Company Name' %}</label>
          <input type="text" x-model="form.name" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="{% trans 'Enter company name' %}">
        </div>
        <!-- Company Type -->
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Company Type' %}</label>
          <select x-model="form.company_type" 
                  class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 {% if is_distributor_user %}bg-gray-100{% endif %}"
                  {% if is_distributor_user %}disabled{% endif %}>
            <option value="">{% trans 'Select type' %}</option>
            <option value="main">{% trans 'Main' %}</option>
            <option value="distributor">{% trans 'Distributor' %}</option>
            <option value="enduser">{% trans 'End User' %}</option>
          </select>
        </div>
      </div>
      <!-- 2nd row: Core Business & Related Company -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Core Business' %}</label>
          <select x-model="form.core_business" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="">{% trans 'Select Core Business' %}</option>
            {% for cb in core_businesses %}
              <option value="{{ cb.id }}">{{ cb.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Related Company' %}</label>
          <select x-model="form.related_company" 
                  class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                  {% if companies|length == 1 %}disabled{% endif %}>
            <option value="">{% trans 'Select Related Company' %}</option>
            {% for company_option in companies %}
              <option value="{{ company_option.id }}" {% if companies|length == 1 %}selected{% endif %}>{{ company_option.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <!-- 3rd row: Related Manager -->
      <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Related Manager' %}</label>
          <select x-model="form.related_manager" 
                  class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 {% if is_distributor_user %}bg-gray-100{% endif %}"
                  {% if is_distributor_user %}disabled{% endif %}>
            <option value="">{% trans 'Select Manager' %}</option>
            {% for manager in managers %}
              <option value="{{ manager.id }}" {% if default_related_manager_id and manager.id|stringformat:"s" == default_related_manager_id|stringformat:"s" %}selected{% endif %}>{{ manager.full_name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <!-- 4th row: Email & Phone -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Email' %}</label>
          <input type="email" x-model="form.email" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="{% trans 'Enter email address' %}">
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700">{% trans 'Telephone' %}</label>
          <input type="tel" x-model="form.telephone" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="{% trans 'Enter telephone number' %}">
        </div>
      </div>
      <!-- 5th row: Active Status -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex items-center">
          <input type="checkbox" x-model="form.active" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label class="ml-2 block text-sm text-gray-900">{% trans 'Active' %}</label>
        </div>
      </div>
    </div>

    <!-- Contacts Tab -->
    <div x-show="activeTab === 'contacts'" class="space-y-4">
      <div class="flex justify-end items-center">
        <button type="button" @click="addContact()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
          {% trans 'Add Contact' %}
        </button>
      </div>
      
      <template x-for="(contact, index) in form.contacts" :key="index">
        <div class="border rounded p-4 space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-medium" x-text="`{% trans 'Contact' %} ${index + 1}`"></h4>
            <button type="button" @click="removeContact(index)" class="text-red-600 hover:text-red-800 text-sm">
              {% trans 'Remove' %}
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Full Name' %}</label>
              <input type="text" x-model="contact.full_name" class="mt-1 text-sm h-10 w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Title' %}</label>
              <input type="text" x-model="contact.title" class="mt-1 text-sm h-10 w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Email' %}</label>
              <input type="email" x-model="contact.email" class="mt-1 text-sm h-10 w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Telephone' %}</label>
              <input type="tel" x-model="contact.telephone" class="mt-1 text-sm h-10 w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>
        </div>
      </template>
      
      <div x-show="form.contacts.length === 0" class="text-center text-gray-500 py-8">
        {% trans 'No contacts added. Click "Add Contact" to create one.' %}
      </div>
    </div>

    <!-- Addresses Tab -->
    <div x-show="activeTab === 'addresses'" class="space-y-4">
      <div class="flex justify-end items-center">
        <button type="button" @click="addAddress()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
          {% trans 'Add Address' %}
        </button>
      </div>
      
      <template x-for="(address, index) in form.addresses" :key="index">
        <div class="border rounded p-4 space-y-4">
          <div class="flex justify-between items-center">
            <h4 class="font-medium" x-text="`{% trans 'Address' %} ${index + 1}`"></h4>
            <button type="button" @click="removeAddress(index)" class="text-red-600 hover:text-red-800 text-sm">
              {% trans 'Remove' %}
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Address Name' %}</label>
              <input type="text" x-model="address.name" class="mt-1 text-sm h-10 w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Country' %}</label>
              <select x-model="address.country" @change="fetchCities(index)" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">{% trans 'Select Country' %}</option>
                <template x-for="country in countries" :key="country.id">
                  <option :value="country.id" x-text="country.name" :selected="address.country == country.id"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'City' %}</label>
              <select x-model="address.city" @change="fetchCounties(index)" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">{% trans 'Select City' %}</option>
                <template x-for="city in address.cities || []" :key="city.id">
                  <option :value="city.id" x-text="city.name" :selected="address.city == city.id"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'County' %}</label>
              <select x-model="address.county" @change="fetchDistricts(index)" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">{% trans 'Select County' %}</option>
                <template x-for="county in address.counties || []" :key="county.id">
                  <option :value="county.id" x-text="county.name" :selected="address.county == county.id"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'District' %}</label>
              <select x-model="address.district" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">{% trans 'Select District' %}</option>
                <template x-for="district in address.districts || []" :key="district.id">
                  <option :value="district.id" x-text="district.name" :selected="address.district == district.id"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700">{% trans 'Zip Code' %}</label>
              <input type="text" x-model="address.zipcode" class="mt-1 text-sm h-10 w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700">{% trans 'Address' %}</label>
            <textarea x-model="address.address" rows="3" class="mt-1 text-sm w-full rounded border border-blue-100 shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
        </div>
      </template>
      
      <div x-show="form.addresses.length === 0" class="text-center text-gray-500 py-8">
        {% trans 'No addresses added. Click "Add Address" to create one.' %}
      </div>
    </div>

    <!-- Working Hours Tab -->
    <div x-show="activeTab === 'working_hours'" class="space-y-6">
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <div class="flex items-center mb-4">
          <svg class="w-6 h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h3 class="text-lg font-semibold text-gray-900">{% trans 'Working Hours Configuration' %}</h3>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Daily Working Hours -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">{% trans 'Daily Working Hours' %}</label>
            <div class="relative">
              <input 
                type="number" 
                x-model.number="form.working_hours.daily_working_hours" 
                min="1" 
                max="24" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="8">
              <span class="absolute right-3 top-2 text-sm text-gray-500">{% trans 'hours' %}</span>
            </div>
            <p class="text-xs text-gray-500">{% trans 'Maximum 24 hours per day' %}</p>
          </div>
          
          <!-- Saturday Work -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">{% trans 'Saturday Work' %}</label>
            <div class="flex items-center space-x-3">
              <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="form.working_hours.working_on_saturday" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 transition-all duration-300 peer-checked:bg-blue-600 relative">
                  <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-all duration-300 peer-checked:translate-x-5"></div>
                </div>
                <span class="ml-3 text-sm text-gray-700" x-text="form.working_hours.working_on_saturday ? '{% trans "Working" %}' : '{% trans "Not Working" %}'"></span>
              </label>
            </div>
          </div>
          
          <!-- Sunday Work -->
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">{% trans 'Sunday Work' %}</label>
            <div class="flex items-center space-x-3">
              <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="form.working_hours.working_on_sunday" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 transition-all duration-300 peer-checked:bg-blue-600 relative">
                  <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-all duration-300 peer-checked:translate-x-5"></div>
                </div>
                <span class="ml-3 text-sm text-gray-700" x-text="form.working_hours.working_on_sunday ? '{% trans "Working" %}' : '{% trans "Not Working" %}'"></span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Weekly Summary -->
        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-blue-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 00-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div>
              <h4 class="text-sm font-medium text-blue-800">{% trans 'Weekly Summary' %}</h4>
              <div class="mt-1 text-sm text-blue-700">
                <p><strong x-text="(form.working_hours.daily_working_hours || 0) * 5 + (form.working_hours.working_on_saturday ? (form.working_hours.daily_working_hours || 0) : 0) + (form.working_hours.working_on_sunday ? (form.working_hours.daily_working_hours || 0) : 0)"></strong> {% trans 'hours per week' %}</p>
                <p><strong x-text="5 + (form.working_hours.working_on_saturday ? 1 : 0) + (form.working_hours.working_on_sunday ? 1 : 0)"></strong> {% trans 'working days per week' %}</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Info Box -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <div class="flex items-start space-x-2">
            <svg class="w-5 h-5 text-gray-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div>
              <h5 class="text-sm font-medium text-gray-800">{% trans 'Information' %}</h5>
              <p class="text-xs text-gray-600 mt-1">
                {% trans 'These working hours will be used to calculate service and warranty periods based on actual usage time.' %}
                {% trans 'You can modify these settings anytime as business requirements change.' %}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="flex justify-end space-x-4 pt-6 border-t">
      <a href="{% url 'customer:customer_detail' company.pk %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded">
        {% trans 'Cancel' %}
      </a>
      <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">
        {% trans 'Update Customer' %}
      </button>
    </div>
  </form>
</div>

<script>
  function customerForm() {
    return {
    activeTab: 'general',
    form: {
      name: '',
      company_type: '',
      core_business: '',
      related_company: '',
      related_manager: '',
      email: '',
      telephone: '',
      active: true,
      contacts: [],
      addresses: [],
      working_hours: {
        daily_working_hours: 8,
        working_on_saturday: false,
        working_on_sunday: false
      }
    },
    countries: [],
    coreBusinesses: [],
    managers: [],
    companies: [],
    init() {
      // Use injected JSON if available, otherwise fetch
      const managersData = document.getElementById('managers-data');
      const coreBusinessesData = document.getElementById('core-businesses-data');
      const countriesData = document.getElementById('countries-data');
      const companiesData = document.getElementById('companies-data');
      const contactsData = document.getElementById('contacts-data');
      const addressesData = document.getElementById('addresses-data');
      const companyData = document.getElementById('company-data');
      
      if (managersData) {
        this.managers = JSON.parse(managersData.textContent);
      } else {
        this.fetchManagers();
      }
      if (coreBusinessesData) {
        this.coreBusinesses = JSON.parse(coreBusinessesData.textContent);
      } else {
        this.fetchCoreBusinesses();
      }
      if (countriesData) {
        this.countries = JSON.parse(countriesData.textContent);
        console.log('Loaded countries:', this.countries);
      } else {
        this.fetchCountries();
      }
      if (companiesData) {
        this.companies = JSON.parse(companiesData.textContent);
        // Auto-select if only one company (for distributor users)
        if (this.companies.length === 1) {
          this.form.related_company = this.companies[0].id.toString();
        }
      }
      
      // Load existing company data
      if (companyData) {
        const company = JSON.parse(companyData.textContent);
        Object.assign(this.form, company);
        // Convert string values to appropriate types
        this.form.core_business = company.core_business ? company.core_business.toString() : '';
        this.form.related_company = company.related_company ? company.related_company.toString() : '';
        this.form.related_manager = company.related_manager ? company.related_manager.toString() : '';
      }
      
      // Load existing contacts
      if (contactsData) {
        this.form.contacts = JSON.parse(contactsData.textContent);
      }
      
      // Load existing addresses
      if (addressesData) {
        this.form.addresses = JSON.parse(addressesData.textContent);
        console.log('Loaded addresses:', this.form.addresses);
        // Convert string values to appropriate types for addresses and load related data
        this.form.addresses.forEach((address, index) => {
          console.log(`Processing address ${index}:`, address);
          console.log(`Address ${index} cities:`, address.cities);
          console.log(`Address ${index} counties:`, address.counties);
          console.log(`Address ${index} districts:`, address.districts);
          
          if (address.country) address.country = address.country.toString();
          if (address.city) address.city = address.city.toString();
          if (address.county) address.county = address.county.toString();
          if (address.district) address.district = address.district.toString();
          
          // Ensure cities, counties, districts arrays exist (they come from backend)
          address.cities = address.cities || [];
          address.counties = address.counties || [];
          address.districts = address.districts || [];
          
          console.log(`Address ${index} after processing:`, address);
          console.log(`Address ${index} final cities count:`, address.cities.length);
          console.log(`Address ${index} final counties count:`, address.counties.length);
          console.log(`Address ${index} final districts count:`, address.districts.length);
        });
      }
      
      // Load existing working hours data
      const workingHoursData = document.getElementById('working-hours-data');
      if (workingHoursData) {
        const workingHours = JSON.parse(workingHoursData.textContent);
        this.form.working_hours = workingHours;
      }
      
      // Auto-set values for distributor users
      const userContextData = document.getElementById('user-context-data');
      if (userContextData) {
        const userContext = JSON.parse(userContextData.textContent);
        if (userContext.is_distributor_user) {
          this.form.company_type = 'enduser';
          if (userContext.default_related_manager_id) {
            this.form.related_manager = userContext.default_related_manager_id;
          }
        }
      }
    },
    fetchCoreBusinesses() {
      fetch('/customer/api/core-businesses/')
        .then(res => res.json())
        .then(data => { this.coreBusinesses = data; });
    },
    fetchManagers() {
      fetch('/customer/api/managers/')
        .then(res => res.json())
        .then(data => { this.managers = data; });
    },
    fetchCountries() {
      fetch('/customer/api/countries/')
        .then(res => res.json())
        .then(data => { this.countries = data; });
    },
    fetchCities(idx) {
      const countryId = this.form.addresses[idx].country;
      console.log(`Fetching cities for country ${countryId}, address index ${idx}`);
      if (!countryId) {
        this.form.addresses[idx].cities = [];
        this.form.addresses[idx].city = '';
        return;
      }
      fetch(`/customer/api/cities/?country=${countryId}`)
        .then(res => res.json())
        .then(data => { 
          console.log(`Received cities for country ${countryId}:`, data);
          this.form.addresses[idx].cities = data; 
          // Clear city selection when country changes
          this.form.addresses[idx].city = '';
          this.form.addresses[idx].counties = [];
          this.form.addresses[idx].county = '';
          this.form.addresses[idx].districts = [];
          this.form.addresses[idx].district = '';
        })
        .catch(err => console.error('Error fetching cities:', err));
    },
    fetchCounties(idx) {
      const cityId = this.form.addresses[idx].city;
      console.log(`Fetching counties for city ${cityId}, address index ${idx}`);
      if (!cityId) {
        this.form.addresses[idx].counties = [];
        this.form.addresses[idx].county = '';
        return;
      }
      fetch(`/customer/api/counties/?city=${cityId}`)
        .then(res => res.json())
        .then(data => { 
          console.log(`Received counties for city ${cityId}:`, data);
          this.form.addresses[idx].counties = data; 
          // Clear county selection when city changes
          this.form.addresses[idx].county = '';
          this.form.addresses[idx].districts = [];
          this.form.addresses[idx].district = '';
        })
        .catch(err => console.error('Error fetching counties:', err));
    },
    fetchDistricts(idx) {
      const countyId = this.form.addresses[idx].county;
      console.log(`Fetching districts for county ${countyId}, address index ${idx}`);
      if (!countyId) {
        this.form.addresses[idx].districts = [];
        this.form.addresses[idx].district = '';
        return;
      }
      fetch(`/customer/api/districts/?county=${countyId}`)
        .then(res => res.json())
        .then(data => { 
          console.log(`Received districts for county ${countyId}:`, data);
          this.form.addresses[idx].districts = data; 
          // Clear district selection when county changes
          this.form.addresses[idx].district = '';
        })
        .catch(err => console.error('Error fetching districts:', err));
    },
    addContact() {
      this.form.contacts.push({
        full_name: '',
        title: '',
        email: '',
        telephone: ''
      });
    },
    removeContact(index) {
      const confirmed = confirm('{% trans "Are you sure you want to remove this contact?" %}');
      if (confirmed) {
        this.form.contacts.splice(index, 1);
      }
    },
    addAddress() {
      this.form.addresses.push({
        name: '',
        country: '',
        city: '',
        county: '',
        district: '',
        zipcode: '',
        address: '',
        cities: [],
        counties: [],
        districts: []
      });
    },
    removeAddress(index) {
      const confirmed = confirm('{% trans "Are you sure you want to remove this address?" %}');
      if (confirmed) {
        this.form.addresses.splice(index, 1);
      }
    }
  }
}
</script>
{% endblock %}
